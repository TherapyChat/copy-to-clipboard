<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./copy-to-clipboard-script.html">

<script>
  /* global ClipboardJS */
  /** @polymerBehavior Polymer.CopyToClipboardBehavior */
  Polymer.CopyToClipboardBehavior = {

    properties: {
      clipboard: Object,
      clipboardAction: {
        type: String,
        value: 'copy'
      },
      clipboardButtonSelector: {
        type: String,
        value: '.clipboard-button'
      },
      clipboardCopiedValue: {
        type: String,
        notify: true,
        readOnly: true
      },
      clipboardSupported: {
        type: Boolean,
        value: false
      },
      clipboardTargetSelector: String
    },

    attached: function () {
      this.clipboardSupported = ClipboardJS.isSupported()

      if (!this.clipboardSupported) return

      this.setupClipboard(this.clipboardButtonSelector)
    },

    detached: function () {
      this.clipboardDestroy()
    },

    clipboardDestroy: function () {
      if (this.clipboard) this.clipboard.destroy()
      this.clipboard = undefined
    },

    clipboardSetup: function (buttonSelector, options) {
      if (!buttonSelector) throw new Error('You need to provide a clipboardButtonSelector')

      var clipboardButton = Polymer.dom(this.root).querySelector(buttonSelector)

      if (clipboardButton) {
        if (this.clipboardTargetSelector) {
          clipboardButton.setAttribute('data-clipboard-target', this.clipboardTargetSelector)
        }

        if (this.clipboardAction !== this.properties.clipboardAction.value) {
          clipboardButton.setAttribute('data-clipboard-action', this.clipboardAction)
        }

        this.clipboard = options ? new ClipboardJS(buttonSelector) : new ClipboardJS(buttonSelector, options)

        this.clipboard.on('success', this._onCopyToClipboardSuccess)
        this.clipboard.on('error', this._onCopyToClipboardError)
      }
    },

    _onCopyToClipboardError: function (ev) {
      this.dispatchEvent(new CustomEvent('copy-to-clipboard-error', {
        detail: ev
      }))
    },

    _onCopyToClipboardSuccess: function (ev) {
      this.setClipboardCopiedValue = ev.text

      this.dispatchEvent(new CustomEvent('copy-to-clipboard-success', {
        detail: ev
      }))
    }
  }
</script>
